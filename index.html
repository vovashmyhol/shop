<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Turbo Gifts — modal full-screen + inventory</title>

<!-- Telegram Web Apps SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<!-- lottie-web для .json -->
<script src="https://cdn.jsdelivr.net/npm/lottie-web@5.12.2/build/player/lottie.min.js"></script>
<!-- rlottie (для .tgs) -->
<script src="https://cdn.jsdelivr.net/npm/rlottie@2.6.0/dist/rlottie.min.js"></script>
<!-- GSAP для плавной анимации скрытия/появления -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<style>
:root{
  --bg:#0f1116;
  --bg-soft:#151822;
  --card-bg:#1a1e2a;
  --text:#ffffff;
  --muted:#c8cdd6;
  --accent-blue-start:#3abefc;
  --accent-blue-end:#6aa8ff;
  --gold:#FFD14B;
  --radius:18px;
  --card-footer-h:56px; 
  --tab-size:46px; 
  --shadow: 0 10px 30px rgba(0,0,0,.35);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Inter, "SF Pro", Arial, sans-serif;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  line-height:1.35;
}

/* --- App container --- */
.app{
  max-width: 560px;
  margin: 0 auto;
  min-height: 100vh;
  padding-bottom: calc(var(--tab-size) + 28px); 
}

/* --- Topbar --- */
.topbar{
  position: sticky;
  top:0;
  z-index:40;
  padding: 6px 12px;
  background: linear-gradient(180deg, rgba(15,17,22,.98), rgba(15,17,22,.92) 70%, rgba(15,17,22,0));
  border-bottom: 1px solid rgba(255,255,255,.04);
  backdrop-filter: blur(6px);
}
.profile{ display:flex; align-items:center; gap:8px; }
.avatar{
  width:40px; height:40px; border-radius:50%;
  background:#222; background-position:center; background-size:cover;
  border:2px solid #303544; flex-shrink:0;
}
.name{ font-weight:700; font-size:17px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* --- Banner --- */
.banner{
  margin:12px 14px;
  padding: 13px 12px;
  border-radius: 14px;
  background: linear-gradient(90deg, var(--accent-blue-start), var(--accent-blue-end));
  display:flex; align-items:center; justify-content:space-between;
  box-shadow: var(--shadow);
}
.banner .title{ font-weight:800; font-size:15px; margin:0px 8px; }
.banner .btn{
  background: #fff;
  color: #09b5ff;
  font-weight:700;
  padding:6px 10px;
  border-radius:12px;
  text-decoration:none;
  font-size:13px;
  display:inline-flex; align-items:center; gap:8px;
  margin:0px 7px;
}

/* --- Toggle --- */
.toggle{
  margin: 10px 14px 0;
  padding: 12px 14px;
  background: var(--bg-soft);
  border:1px solid #222838;
  border-radius: 16px;
  display:flex; align-items:center; gap:12px;
}
.toggle input{
  appearance:none; width:22px;height:22px;border-radius:6px;
  border:2px solid #556079; display:grid; place-items:center;
  background:#0f1116;
}
.toggle input:checked{ background:#1f283b; border-color:#6aa8ff; }
.toggle input:checked::after{ content:"✓"; color:#a8c9ff; font-size:14px; line-height:1; }
.toggle label{ color: var(--text); font-weight:600; cursor:pointer; user-select:none; }

/* --- Grid --- */
.grid{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap:14px;
  padding: 14px;
  justify-items:center;
  align-items:start;
}

/* --- Card --- */
.card{
  position:relative;
  overflow:hidden;
  border-radius:16px;
  background: radial-gradient(120% 120% at 0% 0%, #20263a 0%, #1a1f2d 40%, #161b28 100%);
  border:1px solid #262c41;
  width:100%;
  max-width: 260px;
  height: 260px; 
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
  box-shadow: var(--shadow);
  transition: transform .12s ease;
  cursor:pointer;
}
@media (max-width:420px){
  .card{ height: 200px; }
}
.card:active{ transform: translateY(1px); }

.card .media{
  position: absolute;
  left:0; right:0; top:0;
  height: calc(100% - var(--card-footer-h));
  display:flex; align-items:center; justify-content:center;
  padding: 14px;
}
.media canvas, .media svg, .media img, .media div{ max-width:100%; max-height:100%; border-radius:16px; }

/* --- Footer --- */
.card .footer{
  height: var(--card-footer-h);
  display:flex; align-items:center; justify-content:center;
  position:relative;
  padding: 10px 14px;
  background: linear-gradient(180deg, rgba(11,13,18,.35), rgba(11,13,18,.55));
  border-top: 1px solid rgba(255,255,255,.03);
  backdrop-filter: blur(4px);
}
.card .footer .price {
  display:inline-flex; align-items:center; gap:8px;
  background: linear-gradient(180deg, rgba(255, 210, 75, 0.140), rgba(255, 195, 45, 0.140));
  padding:6px 13px; border-radius:16px;
  color:#51ff00d2; font-weight:700; font-size:15px;
  box-shadow: 0 6px 16px rgba(0,0,0,.22);
}
.price-icon { width:16px; height:16px; object-fit:contain; border-radius:3px; }

.ribbon {
  position: absolute;
  top: 12px;
  right: -25px;
  width: 120px;
  height: 24px;                
  display: flex;
  align-items: center;         
  justify-content: center;     
  transform: rotate(35deg);
  background-color: #ff4d4f;
  color: #fff;
  font-weight: 700;
  font-size: 12px;
  border-radius: 6px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.25);
  pointer-events: none;
  line-height: 1;
  padding: 0 8px;              
}
.ribbon.sold { background-color: #ff8a95; }
.ribbon.sold { background: linear-gradient(180deg, #ff8a95, #e64655); }
.ribbon.stock { background: linear-gradient(90deg,#66c2ff,#3aa6ff); }

/* --- Tabbar --- */
.tabbar{
  position: fixed; left:0; right:0; bottom:0; z-index:60;
  display:flex; justify-content:center; align-items:center;
  padding:8px 10px; background: linear-gradient(0deg, rgba(15,17,22,1), rgba(15,17,22,.96));
  border-top:1px solid rgba(255,255,255,.03);
}
.tabs{
  width:min(560px, 100%); display:flex; gap:12px; justify-content:center;
}
.tab{
  width: var(--tab-size); height: var(--tab-size);
  border-radius:12px; background:#111523; border:1px solid #252b3d;
  display:grid; place-items:center; cursor:pointer;
  box-shadow: 0 8px 18px rgba(0,0,0,.25);
  transition: transform .08s;
  overflow:hidden;
}
.tab img{ width:20px; height:20px; object-fit:contain; pointer-events:none; display:block }
.tab.active{ outline:2px solid #3f69ff55; transform: translateY(-2px); }

/* ========= FULLSCREEN MODAL ========= */
.overlay, .purchase-overlay, .inventory-overlay{
  position: fixed; inset:0; z-index:2000; display:none;
  align-items: center; justify-content: center;
  background: rgba(6,8,10,0.95); backdrop-filter: blur(6px);
}
.overlay.open, .purchase-overlay.open, .inventory-overlay.open{ display:flex; }

.modal-card{
  width:100%; height:100%; max-height:100vh;
  background: linear-gradient(180deg,#0f1116,#0b0d10);
  border-radius:0;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  padding-bottom:16px;
}
.modal-top{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid rgba(255,255,255,0.03); }
.modal-title { font-weight:800; font-size:20px; }
.modal-close { background:transparent; border:0; color:var(--muted); font-weight:700; cursor:pointer; font-size:16px; }

.modal-body{ flex:1; display:flex; align-items:center; justify-content:center; padding: 8px; overflow:auto; }
.modal-media-wrap{
  width:80%; max-width:400px; height:80%;
  display:flex; align-items:center; justify-content:center;
  border-radius:16px; background: linear-gradient(180deg,#1a1e2a,#161b28); padding:12px;
}
.modal-media{ width:100%; height:100%; display:flex; align-items:center; justify-content:center; border-radius:16px; }

.modal-bottom{
  padding:18px 16px; display:flex; flex-direction:column; gap:8px;
}
.price-row{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
.price-pill{
  display:inline-flex; align-items:center; gap:10px;
  background: linear-gradient(180deg, rgba(255, 210, 75, 0.140), rgba(255, 195, 45, 0.140));
  color:#51ff00d2; padding:10px 14px; border-radius:16px; font-weight:650; font-size:17px; box-shadow: 0 8px 20px rgba(0,0,0,.35);
}
.modal-actions{ display:flex; gap:12px; flex-direction:column; }
.btn-ghost{
  background: rgba(255,255,255,0.06); color:#fff; padding:14px; border-radius:12px; text-align:center; border:1px solid rgba(255,255,255,0.03); font-weight:800; text-decoration:none;
}
.btn-primary{
  background: linear-gradient(90deg,#2fa6ff,#1a73ff); color:#fff; padding:16px; border-radius:12px; text-align:center; font-weight:900; text-decoration:none;
}

/* PURCHASE SUCCESS FULLSCREEN */
.purchase-card{
  width:100%; height:100%; max-height:100vh;
  background: linear-gradient(180deg,#0b0d11,#0e1114);
  display:flex; flex-direction:column; align-items:center; justify-content:center; padding:16px;
}
.purchase-media{ width:200px; height:200px; display:flex; align-items:center; justify-content:center; border-radius:16px; margin-bottom:16px; }
.purchase-title{ font-size:22px; font-weight:800; text-align:center; margin-bottom:4px; }
.purchase-subtitle{ font-size:13px; color:#888da0; text-align:center; margin-bottom:16px; }
.purchase-close{
  margin-top:auto; width:95%; max-width:720px; text-align:center;
  background: #2fa6ff; color:#fff; padding:16px; border-radius:12px; font-weight:900; cursor:pointer;
}

/* INVENTORY THIRD TAB */
.inventory-container{
  width:100%; padding:14px; display:flex; flex-direction:column; align-items:center; overflow:auto;
}
.inventory-user{
  display:flex; flex-direction:column; align-items:center; margin-bottom:12px;
}
.inventory-user .avatar{ width:80px; height:80px; margin-bottom:6px; }
.inventory-user .name{ font-weight:700; font-size:18px; }
.divider{ width:60%; height:1px; background:#333840; margin:12px 0; border-radius:1px; }
.inventory-grid{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap:14px;
  width:100%;
  justify-items:center;
  align-items:start;
}
.inventory-card{
  position:relative;
  overflow:hidden;
  border-radius:16px;
  background: radial-gradient(120% 120% at 0% 0%, #20263a 0%, #1a1f2d 40%, #161b28 100%);
  border:1px solid #262c41;
  width:100%;
  max-width: 260px;
  height: 260px;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
  box-shadow: var(--shadow);
}
.inventory-card .media{ border-radius:16px; }
.inventory-card .footer{ justify-content:center; background:none; border-top:none; }
.inventory-card .btn-improve{
  display:block; width:80%; margin:6px auto; padding:10px; background:#666c80; color:#ccc; text-align:center; border-radius:12px; font-weight:700; cursor:not-allowed;
  font-size:14px; text-decoration:none;
}
</style>
</head>
<body>
<div class="app">
  <!-- Topbar -->
  <div class="topbar">
    <div class="profile">
      <div id="avatar" class="avatar" aria-hidden="true"></div>
      <div id="userName" class="name">User</div>
    </div>
  </div>

  <!-- Banner -->
  <div class="banner" role="region" aria-label="banner">
    <div class="title">Check our news!</div>
    <a id="bannerBtn" class="btn" href="https://example.com" target="_blank" rel="noopener noreferrer">Open Gifts</a>
  </div>

  <!-- Toggle -->
  <div class="toggle" role="group" aria-label="Фильтр">
    <input id="hideSold" type="checkbox" />
    <label for="hideSold">Скрыть проданные подарки</label>
  </div>

  <!-- Grid -->
  <div class="grid" id="cardsGrid" aria-live="polite">
    <article class="card" id="card1" data-sold="false" data-invoice-url="#" role="article" aria-label="1 из 100">
      <div class="ribbon stock" aria-hidden="true">1 из 100</div>
      <div class="media lottie" data-lottie-url="https://raw.githubusercontent.com/vovashmyhol/shop/refs/heads/main/002_DOG%20(1).json">
        <div class="lottie-placeholder">Lottie animation 1</div>
      </div>
      <div class="footer">
        <div class="price">
          <img src="stars-DBKMczxe.png" alt="icon" class="price-icon">
          <span class="price-value">10</span>
        </div>
      </div>
    </article>
    <article class="card" id="card2" data-sold="false" data-invoice-url="#" role="article" aria-label="1 из 50">
      <div class="ribbon stock" aria-hidden="true">1 из 50</div>
      <div class="media lottie" data-lottie-url="https://raw.githubusercontent.com/vovashmyhol/shop/refs/heads/main/002_DOG%20(1).json">
        <div class="lottie-placeholder">Lottie animation 2</div>
      </div>
      <div class="footer">
        <div class="price">
          <img src="stars-DBKMczxe.png" alt="icon" class="price-icon">
          <span class="price-value">25</span>
        </div>
      </div>
    </article>
  </div>
</div>

<!-- Tabbar -->
<nav class="tabbar" role="navigation" aria-label="Основная навигация">
  <div class="tabs" role="tablist">
    <div class="tab active" role="tab" aria-selected="true" id="tab1" title="Tab 1">
      <img src="stars-DBKMczxe.png" alt="tab1 icon">
    </div>
    <div class="tab" role="tab" aria-selected="false" id="tab2" title="Tab 2">
      <img src="https://dummyimage.com/64x64/2b3345/ffffff&text=2" alt="tab2 icon">
    </div>
    <div class="tab" role="tab" aria-selected="false" id="tab3" title="Tab 3">
      <img src="https://dummyimage.com/64x64/2b3345/ffffff&text=3" alt="tab3 icon">
    </div>
  </div>
</nav>

<!-- FULLSCREEN ITEM MODAL -->
<div id="itemOverlay" class="overlay" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-card" role="document" aria-label="Детали подарка">
    <div class="modal-top">
      <div class="modal-title" id="modalTitle">Подарок</div>
      <button id="modalCloseBtn" class="modal-close" aria-label="Закрыть модалку">✕</button>
    </div>
    <div class="modal-body">
      <div class="modal-media-wrap">
        <div id="modalLottie" class="modal-media"></div>
      </div>
    </div>
    <div class="modal-bottom">
      <div class="price-row">
        <div class="price-pill" id="modalPricePill">
          <img src="stars-DBKMczxe.png" alt="icon" style="width:18px;height:18px;object-fit:contain">
          <div id="modalPriceValue">15</div>
        </div>
        <div style="color:#9aa3b2;font-weight:600;margin-left:8px" id="modalShort">Краткое описание</div>
      </div>
      <div class="modal-actions">
        <a id="modalBuyStars" class="btn-ghost" href="#" target="_blank" rel="noopener noreferrer">Купить звёзды ★</a>
        <a id="modalBuyGift" class="btn-primary" href="#" target="_blank" rel="noopener noreferrer">Купить подарок — ★ <span id="modalBuyPrice">15</span></a>
      </div>
    </div>
  </div>
</div>

<!-- PURCHASE SUCCESS FULLSCREEN -->
<div id="purchaseOverlay" class="purchase-overlay" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="purchase-card" role="document" aria-label="Куплено">
    <div id="purchasedMedia" class="purchase-media"></div>
    <div class="purchase-title">Подарок куплен!</div>
    <div class="purchase-subtitle">Ваш подарок находится в профиле</div>
    <div id="purchaseCloseBtn" class="purchase-close" role="button" tabindex="0">Закрыть</div>
  </div>
</div>

<!-- INVENTORY THIRD TAB -->
<div id="inventoryTab" class="inventory-overlay" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="inventory-container">
    <div class="inventory-user">
      <div id="inventoryAvatar" class="avatar"></div>
      <div id="inventoryName" class="name">User</div>
    </div>
    <div class="divider"></div>
    <div id="inventoryGrid" class="inventory-grid"></div>
  </div>
</div>

<script>
// Telegram init
(function initTelegramUser(){
  try {
    if(window.Telegram && Telegram.WebApp){
      Telegram.WebApp.ready();
      const initDataUnsafe = Telegram.WebApp.initDataUnsafe || {};
      const user = initDataUnsafe.user || null;
      const nameEl = document.getElementById('userName');
      const avatarEl = document.getElementById('avatar');
      const inventoryName = document.getElementById('inventoryName');
      const inventoryAvatar = document.getElementById('inventoryAvatar');
      if(user){
        const parts = [];
        if(user.first_name) parts.push(user.first_name);
        if(user.last_name) parts.push(user.last_name);
        if(parts.length === 0 && user.username) parts.push(user.username);
        if(parts.length === 0) parts.push('User');
        const fullName = parts.join(' ');
        nameEl.textContent = fullName;
        inventoryName.textContent = fullName;

        if(user.photo_url){
          avatarEl.style.backgroundImage = `url("${user.photo_url}")`;
          inventoryAvatar.style.backgroundImage = `url("${user.photo_url}")`;
        } else {
          const initials = parts.map(p=>p[0]||'').join('').slice(0,2).toUpperCase() || 'U';
          const bg = '#2b3345';
          const fg = '#fff';
          const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='${bg}' rx='40'/><text x='50%' y='50%' font-family='Arial,sans-serif' font-size='90' fill='${fg}' dominant-baseline='middle' text-anchor='middle'>${initials}</text></svg>`;
          avatarEl.style.backgroundImage = `url("data:image/svg+xml;charset=utf8,${encodeURIComponent(svg)}")`;
          inventoryAvatar.style.backgroundImage = `url("data:image/svg+xml;charset=utf8,${encodeURIComponent(svg)}")`;
        }
      }
    }
  } catch(err){ console.warn('Telegram init error', err); }
})();

// Lottie loader
function loadLottieFor(el){
  const url = el.getAttribute('data-lottie-url');
  el.innerHTML = '';
  if(!url){ el.innerHTML = '<div class="lottie-placeholder">Укажите raw ссылку на Lottie (.json или .tgs)</div>'; return; }
  if(/\.json(\?|$)/i.test(url) && window.lottie){
    try { lottie.loadAnimation({ container: el, renderer: 'svg', loop: true, autoplay: true, path: url }); return; } 
    catch(e){ el.innerHTML = '<div class="lottie-placeholder">Ошибка загрузки Lottie JSON</div>'; }
  }
  if(/\.tgs(\?|$)/i.test(url) && window.rlottie){
    try { const player = new rlottie.Player({ name: 'anim-' + Math.random().toString(36).slice(2), src: url, loop: true, autoplay: true, container: el });
          el.style.display = 'grid'; el.style.placeItems = 'center'; return; } 
    catch(e){ el.innerHTML = '<div class="lottie-placeholder">Ошибка загрузки TGS</div>'; }
  }
  if(/\.(svg|png|jpg|jpeg|gif)(\?|$)/i.test(url)){
    const img = document.createElement('img'); img.src = url; img.alt = 'media'; img.style.maxWidth='100%'; img.style.maxHeight='100%'; el.appendChild(img); return;
  }
  el.innerHTML = '<div class="lottie-placeholder">Неподдерживаемый формат</div>';
}
document.querySelectorAll('.media.lottie').forEach(loadLottieFor);

// hide sold toggle
const hideSoldCheckbox = document.getElementById('hideSold');
const soldSelector = '[data-sold="true"]';
function soldCards(){ return Array.from(document.querySelectorAll(soldSelector)); }
function hideSoldAnimated(){ soldCards().forEach(c=>{ if(c.dataset._hidden==='1')return; gsap.to(c,{duration:0.36, ease:'power2.out', opacity:0, scale:0.98, y:-8, onComplete:()=>{ c.style.display='none'; c.dataset._hidden='1'; } }); }); }
function showSoldAnimated(){ soldCards().forEach(c=>{ if(c.dataset._hidden!=='1')return; c.style.display=''; gsap.set(c,{opacity:0, scale:0.98, y:-8}); gsap.to(c,{duration:0.4, ease:'power2.out', opacity:1, scale:1, y:0, onComplete:()=>{ c.dataset._hidden='0'; }}); }); }
hideSoldCheckbox.addEventListener('change', ()=>{ if(hideSoldCheckbox.checked) hideSoldAnimated(); else showSoldAnimated(); });
window.addEventListener('load', ()=>{ if(hideSoldCheckbox.checked) setTimeout(hideSoldAnimated,120); else soldCards().forEach(c=>{ c.dataset._hidden='0'; c.style.display=''; c.style.opacity=1; c.style.transform='none'; }); });

// Item modal
const itemOverlay = document.getElementById('itemOverlay');
const modalCloseBtn = document.getElementById('modalCloseBtn');
const modalTitle = document.getElementById('modalTitle');
const modalLottie = document.getElementById('modalLottie');
const modalPriceValue = document.getElementById('modalPriceValue');
const modalBuyStars = document.getElementById('modalBuyStars');
const modalBuyGift = document.getElementById('modalBuyGift');
const modalBuyPrice = document.getElementById('modalBuyPrice');
const modalShort = document.getElementById('modalShort');

const purchaseOverlay = document.getElementById('purchaseOverlay');
const purchasedMedia = document.getElementById('purchasedMedia');
const purchaseCloseBtn = document.getElementById('purchaseCloseBtn');

let activeCard = null;
let lastLottieUrl = null;
let purchasedGifts = JSON.parse(localStorage.getItem('purchasedGifts')||'[]');

function openItemModal(cardEl){
  activeCard = cardEl;
  const title = cardEl.getAttribute('aria-label') || 'Подарок';
  const price = cardEl.querySelector('.price-value')?.textContent?.trim() || '0';
  const lottieUrl = cardEl.querySelector('.media.lottie')?.getAttribute('data-lottie-url') || '';
  const invoice = cardEl.getAttribute('data-invoice-url') || '#';

  modalTitle.textContent = title;
  modalPriceValue.textContent = price;
  modalBuyPrice.textContent = price;
  modalShort.textContent = ''; 
  modalBuyGift.href = invoice;
  modalBuyStars.href = document.getElementById('bannerBtn').href || '#';

  modalLottie.innerHTML = '';
  if(lottieUrl){ lastLottieUrl = lottieUrl; const c=document.createElement('div'); c.style.width='100%'; c.style.height='100%'; c.setAttribute('data-lottie-url', lottieUrl); modalLottie.appendChild(c); loadLottieFor(c); }
  else modalLottie.innerHTML = '<div class="lottie-placeholder">Нет анимации</div>';

  itemOverlay.classList.add('open'); itemOverlay.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
}

function closeItemModal(){ modalLottie.innerHTML=''; itemOverlay.classList.remove('open'); itemOverlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }

document.querySelectorAll('.card').forEach(card=>{ card.addEventListener('click', ()=>{ openItemModal(card); }); });
modalCloseBtn.addEventListener('click', closeItemModal);
itemOverlay.addEventListener('click', (e)=>{ if(e.target===itemOverlay) closeItemModal(); });

// Buy gift
modalBuyGift.addEventListener('click', (e)=>{
  e.preventDefault();
  const price = parseInt(modalPriceValue.textContent||0,10);
  const selectedLink = "https://t.me/$OEtEnkq5wEppDQAAuOeA4xzWyR4"; // ссылка на invoice
  if(window.Telegram && Telegram.WebApp && Telegram.WebApp.openInvoice){
    Telegram.WebApp.openInvoice(selectedLink);
    // имитация оплаты (в реальном приложении сюда вставляется колбэк)
    setTimeout(()=>{
      handlePaymentSuccess();
    },1000); 
  } else { window.open(modalBuyGift.href,'_blank'); }
});

window.handlePaymentSuccess = function(){
  closeItemModal();
  purchasedMedia.innerHTML='';
  let lottieUrl = activeCard?.querySelector('.media.lottie')?.getAttribute('data-lottie-url') || lastLottieUrl || null;
  if(lottieUrl){ const c=document.createElement('div'); c.style.width='100%'; c.style.height='100%'; c.setAttribute('data-lottie-url', lottieUrl); purchasedMedia.appendChild(c); loadLottieFor(c); }
  else purchasedMedia.innerHTML = '<div class="lottie-placeholder">Нет медиа</div>';
  purchaseOverlay.classList.add('open'); purchaseOverlay.setAttribute('aria-hidden','false');
  document.body.style.overflow='hidden';
  // save purchased
  if(activeCard){
    purchasedGifts.push({
      lottie: lottieUrl,
      price: modalPriceValue.textContent,
      title: activeCard.getAttribute('aria-label')||'Подарок'
    });
    localStorage.setItem('purchasedGifts',JSON.stringify(purchasedGifts));
    updateInventory();
  }
};

function closePurchaseModal(){ purchasedMedia.innerHTML=''; purchaseOverlay.classList.remove('open'); purchaseOverlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
purchaseCloseBtn.addEventListener('click', closePurchaseModal);
purchaseOverlay.addEventListener('click',(e)=>{if(e.target===purchaseOverlay)closePurchaseModal();});

// Tabs
document.querySelectorAll('.tabs .tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.tabs .tab').forEach(t=>{ t.classList.remove('active'); t.setAttribute('aria-selected','false'); });
    tab.classList.add('active'); tab.setAttribute('aria-selected','true');
    if(tab.id==='tab3') showInventoryTab(); else hideInventoryTab();
  });
});

// Inventory functions
const inventoryTab = document.getElementById('inventoryTab');
const inventoryGrid = document.getElementById('inventoryGrid');
function updateInventory(){
  inventoryGrid.innerHTML='';
  purchasedGifts.forEach(gift=>{
    const card = document.createElement('div');
    card.className='inventory-card';
    const mediaWrap = document.createElement('div');
    mediaWrap.className='media lottie';
    mediaWrap.setAttribute('data-lottie-url',gift.lottie);
    loadLottieFor(mediaWrap);
    card.appendChild(mediaWrap);
    const footer = document.createElement('div');
    footer.className='footer';
    const btnImprove = document.createElement('div');
    btnImprove.className='btn-improve';
    btnImprove.textContent='Улучшить';
    footer.appendChild(btnImprove);
    card.appendChild(footer);
    inventoryGrid.appendChild(card);
  });
}
function showInventoryTab(){ inventoryTab.classList.add('open'); inventoryTab.setAttribute('aria-hidden','false'); updateInventory(); }
function hideInventoryTab(){ inventoryTab.classList.remove('open'); inventoryTab.setAttribute('aria-hidden','true'); }

if(typeof gsap==='undefined') console.warn('GSAP не загружен — анимации скрыть/показ упрощены.');
</script>
</body>
</html>
